import React from 'react';
import { Layout
       , Breadcrumb
       , Form
       , Input
       , Button 
       , List
       , Avatar
       } from 'antd';
import { FormInstance } from 'antd/lib/form';
import { DatabaseOutlined } from '@ant-design/icons';
import ModalCircuit from '../results/ModalCircuit';
import { isNumericLiteral } from 'typescript';

const {Content} = Layout;
const tailLayout = {
  wrapperCol: { offset: 9, span: 16 },
};

type FormValues = {
  circuitShortname: string
  circuitLongname: string
  distributionTime: string
  treeID: string  
  calendar: string
  product: string
  groupID: string
} 

class CircuitsLayout extends React.Component<{}, {history: FormValues[], displayResults: boolean}> {

  formRef = React.createRef<FormInstance>();

  constructor(props: any){
    super(props);
    this.state = {
      history: [],
      displayResults: false
    };
  }

  onFinish = (values: FormValues) => {
    const history = this.state.history.concat(values);
    this.setState({history: history});
    this.formRef.current?.resetFields();
  }
  
  render() {

    return (
      <Content style={{ margin: '0 16px' }}>
      <Breadcrumb style={{ margin: '16px 0' }}>
        <Breadcrumb.Item>Query Runner</Breadcrumb.Item>
        <Breadcrumb.Item>New Circuit</Breadcrumb.Item>
      </Breadcrumb>
      <Form
      name="control-ref"
      ref={this.formRef}
      labelCol={{ span: 4 }}
      wrapperCol={{ span: 14 }}
      onFinish={this.onFinish}
      >
        <Form.Item label="circuit_shortname" 
                   name="circuitShortname"
                   hasFeedback
                   rules={[{ required: true, type: 'string' }]}
        >
          <Input placeholder="circuit_shortname" />
        </Form.Item>
        <Form.Item label="circuit_longname" 
                   name="circuitLongname"
                   hasFeedback
                   rules={[{ required: true, type: 'string' }]}
        >
          <Input placeholder="circuit_longname" />
        </Form.Item>
        <Form.Item label="distribution_time" 
                   name="distributionTime"
                   hasFeedback
                   rules={[{ required: true, type: 'string' }]}
        >
          <Input placeholder="distribution_time" />
        </Form.Item>
        <Form.Item label="tree_id" 
                   name="treeID"
                   hasFeedback
                   rules={[{ required: true, type: 'string' }]}
        >
          <Input placeholder="tree_id" />
        </Form.Item>
        <Form.Item label="calendar" 
                   name="calendar"
                   hasFeedback
                   rules={[{ required: true, type: 'string' }]}
        >
          <Input placeholder="calendar" />
        </Form.Item>
        <Form.Item label="product" 
                   name="product"
                   hasFeedback
                   rules={[{ required: true, type: 'string' }]}
        >
          <Input placeholder="product" />
        </Form.Item>
        <Form.Item label="group_id" 
                   name="groupID"
                   hasFeedback
                   rules={[{ required: true, type: 'string'}
                          ,  ({ getFieldValue }) => ({
                                validator(rule, value) {
                                    if (!isNaN(value)) {
                                      return Promise.resolve();
                                    }
                                return Promise.reject('group_id should be numeric');
                                }
                             })
                          ]}
        >
          <Input placeholder="0"/>
        </Form.Item>
        <Form.Item {...tailLayout}>
          <Button type="primary"  htmlType="submit" >Add Query</Button>
          { this.state.history.length > 0 ? <Button htmlType="button" onClick={() => this.showModal()} >Generate SQL</Button> 
                                          : <Button htmlType="button" disabled>Add a query first</Button> 
          }
        </Form.Item>
        <Form.Item label="Query List"
                   shouldUpdate={(prevValues, curValues) => prevValues.history !== curValues.history}
        >
          <List 
              itemLayout="horizontal"
              dataSource={this.state.history}
              bordered
              split
              rowKey={(e) => e.circuitShortname}
              renderItem={(item, index) => (
                <List.Item>
                  <List.Item.Meta
                    avatar={<Avatar icon={<DatabaseOutlined />} />}
                    title={<a href={window.location.href + "/" + index}>{index + ": " + item.circuitShortname}</a> }
                    description={`circuit_shortname: ${item.circuitShortname}, circuit_longname: ${item.circuitLongname}, calendar:${item.calendar}, distribution_time: ${item.distributionTime}, tree_id: ${item.treeID}, group_id: ${item.groupID}, product: ${item.product}`}
                  />
                </List.Item>
              )}
            />
      </Form.Item>
      </Form>
      


      <ModalCircuit visible={this.state.displayResults} 
                    handleOk= {(e: any) => this.handleOk(e)} 
                    handleCancel= {(e: any) => this.handleCancel(e)} 
                    queries={this.state.history.map((e) => this.createQuery(e))}/>
      </Content>
     );
   }


  createQuery = (form: FormValues): string => {
    return `insert into SAN_AC_MR_PRO.MD_CIRCUITS ( CIRCUIT_ID
                                      , CIRCUIT_SHORTNAME
                                      , CIRCUIT_LONGNAME
                                      , DISTRIBUTION_TIME
                                      , TIME_ZONE_ID
                                      , TREE_ID
                                      , CALENDAR
                                      , PRODUCT
                                      , GROUP_ID
                                      , TYPE_ID
                                      )
                               values ( SAN_AC_MR_PRO.CIRCUIT_SEQ.NEXTVAL
                                      , '${form.circuitShortname}'
                                      , '${form.circuitLongname}'
                                      , to_timestamp('${form.distributionTime}', 'yyyy/mm/dd HH24:mi:ss)'
                                      , '${form.treeID}'
                                      , '${form.calendar}'
                                      , '${form.product}'
                                      , ${form.groupID}
                                      , (select TYPE_ID from SAN_AC_MR_PRO.MD_TYPES where TYPE_SHORTNAME = 'MD')
                                      );`;
  }

  showModal = () => {
    this.setState({
      displayResults: true,
    });
  };

  handleOk = (e: any) => {
    this.setState({
      history: [],
      displayResults: false,
    });
  };

  handleCancel = (e: any) => {
    this.setState({
      displayResults: false,
    });
  };

  isNumeric = (s: string) => {
    return !isNaN(parseInt(s));
  }
}

export default CircuitsLayout;